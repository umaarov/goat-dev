name: Quality Gate

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  static-analysis:
    name: Static Analysis & Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          tools: composer, cs2pr
          coverage: none

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Dependencies
        run: |
          composer install --prefer-dist --no-progress --no-suggest
          npm ci

      - name: ESLint
        run: npm run lint

      - name: PHPStan / Psalm
        run: vendor/bin/psalm --output-format=github

      - name: Security Audit (Composer)
        run: composer audit

  security:
    name: Security Scans
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Gitleaks
        uses: zricethezav/gitleaks-action@v2
        with:
          args: detect --source . -v

  tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: static-analysis
    steps:
      - uses: actions/checkout@v6
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv
          coverage: none

      - name: Install Deps
        run: composer install --prefer-dist --no-progress

      - name: Run Tests
        run: php artisan test
