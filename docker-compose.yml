services:
    app:
        build:
            context: .
            dockerfile: Dockerfile
        image: goat-app:latest
        ports:
            - "8000:80"
            - "443:443"
            - "443:443/udp"
        environment:
            APP_ENV: production
            APP_DEBUG: false
            APP_KEY: ${APP_KEY}
            DB_CONNECTION: mysql
            DB_HOST: db
            DB_PORT: 3306
            DB_DATABASE: ${DB_DATABASE}
            DB_USERNAME: ${DB_USERNAME}
            DB_PASSWORD: ${DB_PASSWORD}
            REDIS_HOST: redis
            REDIS_PORT: 6379
            REDIS_CLIENT: phpredis
            CACHE_STORE: redis
            SESSION_DRIVER: redis
            QUEUE_CONNECTION: redis
        volumes:
            - ./:/app
            #            - /app/node_modules
            #            - /app/vendor
            - ./docker/Caddyfile:/etc/caddy/Caddyfile
            - ./docker/php.ini:/usr/local/etc/php/conf.d/custom.ini
        depends_on:
            - db
            - redis
        networks:
            - goat-network
        healthcheck:
            test: [ "CMD", "curl", "-f", "http://localhost:80/up" ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 10s

    worker:
        image: goat-app:latest
        restart: unless-stopped
        command: php artisan queue:work --tries=3 --timeout=90
        environment:
            APP_ENV: production
            DB_CONNECTION: mysql
            DB_HOST: db
            REDIS_HOST: redis
            REDIS_CLIENT: phpredis
            QUEUE_CONNECTION: redis
            CACHE_STORE: redis
        volumes:
            - ./:/app
            - ./docker/php.ini:/usr/local/etc/php/conf.d/custom.ini
        depends_on:
            - db
            - redis
        networks:
            - goat-network

    scheduler:
        image: goat-app:latest
        restart: unless-stopped
        command: php artisan schedule:work
        environment:
            APP_ENV: production
            DB_CONNECTION: mysql
            DB_HOST: db
            REDIS_HOST: redis
            REDIS_CLIENT: phpredis
            QUEUE_CONNECTION: redis
            CACHE_STORE: redis
        volumes:
            - ./:/app
            - ./docker/php.ini:/usr/local/etc/php/conf.d/custom.ini
        depends_on:
            - db
            - redis
        networks:
            - goat-network
    db:
        image: mysql:8.0
        restart: always
        deploy:
            resources:
                limits:
                    cpus: '1.0'
                    memory: 1G
        ports:
            - "${DB_PORT}:3306"
        environment:
            MYSQL_ROOT_PASSWORD: "${DB_PASSWORD}"
            MYSQL_DATABASE: "${DB_DATABASE}"
            MYSQL_USER: "${DB_USERNAME}"
            MYSQL_PASSWORD: "${DB_PASSWORD}"
        volumes:
            - goat-db-data:/var/lib/mysql
        networks:
            - goat-network
        healthcheck:
            test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
            timeout: 20s
            retries: 10

    redis:
        image: redis:alpine
        restart: always
        command: redis-server --appendonly yes
        volumes:
            - goat-redis-data:/data
        networks:
            - goat-network

    pulse:
        image: goat-app:latest
        restart: unless-stopped
        command: php artisan pulse:check
        environment:
            APP_ENV: production
            DB_CONNECTION: mysql
            DB_HOST: db
            REDIS_HOST: redis
            REDIS_CLIENT: phpredis
        depends_on:
            - db
            - redis
        networks:
            - goat-network

networks:
    goat-network:
        driver: bridge

volumes:
    goat-db-data:
    goat-redis-data:
