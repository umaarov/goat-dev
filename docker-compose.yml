services: #  traefik:
    #    image: traefik:v3.0
    #    restart: always
    #    command:
    #      - "--api.insecure=true"
    #      - "--providers.docker=true"
    #      - "--providers.docker.exposedbydefault=false"
    #      - "--entrypoints.web.address=:80"
    #      - "--entrypoints.websecure.address=:443"
    #      # - "--certificatesresolvers.myresolver.acme.tlschallenge=true"
    #      # - "--certificatesresolvers.myresolver.acme.email=hs.umarov21@gmail.com"
    #      # - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
    #    ports:
    #      - "80:80"
    #      - "443:443"
    #      - "8080:8080"
    #    volumes:
    #      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    #      - "./letsencrypt:/letsencrypt"
    #    networks:
    #      - goat-network
    app:
        build:
            context: .
            dockerfile: Dockerfile
            args:
                VITE_PUSHER_APP_KEY: ${PUSHER_APP_KEY}
                VITE_PUSHER_APP_CLUSTER: ${PUSHER_APP_CLUSTER}
        image: goat-app:latest
        restart: unless-stopped
        deploy:
            resources:
                limits:
                    cpus: '1.5'
                    memory: 2G
        ports:
            - "80:80"
            - "443:443"
            - "443:443/udp"
        environment:
            APP_SCHEME: https
            APP_ENV: production
            APP_DEBUG: false
            SERVER_NAME: ":80"
            #            TRUSTED_PROXIES: "*"
            APP_KEY: ${APP_KEY}
            DB_CONNECTION: mysql
            DB_HOST: db
            DB_PORT: 3306
            DB_DATABASE: ${DB_DATABASE}
            DB_USERNAME: ${DB_USERNAME}
            DB_PASSWORD: ${DB_PASSWORD}
            REDIS_HOST: redis
            REDIS_PORT: 6379
            REDIS_CLIENT: phpredis
            CACHE_STORE: redis
            SESSION_DRIVER: redis
            QUEUE_CONNECTION: redis
            PUSHER_APP_ID: ${PUSHER_APP_ID}
            PUSHER_APP_KEY: ${PUSHER_APP_KEY}
            PUSHER_APP_SECRET: ${PUSHER_APP_SECRET}
            PUSHER_APP_CLUSTER: ${PUSHER_APP_CLUSTER}
            PUSHER_HOST: ${PUSHER_HOST}
            PUSHER_PORT: ${PUSHER_PORT}
            PUSHER_SCHEME: ${PUSHER_SCHEME}
            PUSHER_APP_ENCRYPTED: ${PUSHER_APP_ENCRYPTED}
            VITE_PUSHER_APP_KEY: ${PUSHER_APP_KEY}
            VITE_PUSHER_APP_CLUSTER: ${PUSHER_APP_CLUSTER}
        env_file:
            - .env
#        read_only: true
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"
        tmpfs:
            - /tmp
            - /var/run
            - /var/log
            - /app/bootstrap/cache
        volumes: #            - ./:/app
            #            - /app/node_modules
            - /app/vendor
            #            - /app/public/build
            - ./docker/Caddyfile:/etc/caddy/Caddyfile
            - caddy_data:/data
            #            - ./docker/php.ini:/usr/local/etc/php/conf.d/custom.ini
            - ./docker/php.ini:/usr/local/etc/php/conf.d/custom.ini:ro
            - ./docker/certs:/etc/caddy/certs
            - goat-storage:/app/storage/app/public
            - ./docs:/app/docs
        depends_on:
            - db
            - redis
        networks:
            - goat-network
        #    labels:
        #      - "traefik.enable=true"
        #      - "traefik.http.routers.app.rule=Host(`localhost`) || Host(`goat.uz`)"
        #      - "traefik.http.routers.app.entrypoints=web"
        #      - "traefik.http.services.app.loadbalancer.server.port=80"
        #      # - "traefik.http.routers.app.entrypoints=websecure"
        #      # - "traefik.http.routers.app.tls.certresolver=myresolver"
        cap_drop:
            - ALL
        cap_add:
            - CHOWN
            - SETGID
            - SETUID
            - NET_BIND_SERVICE
        healthcheck:
            test: [ "CMD-SHELL", "curl -sf http://127.0.0.1/up || exit 1" ]
            interval: 30s
            timeout: 5s
            retries: 5
            start_period: 30s

        command: frankenphp run --config /etc/caddy/Caddyfile

    worker:
        build: .
        image: goat-app:latest
        restart: unless-stopped
        command: php artisan queue:work --tries=3 --timeout=90
        healthcheck:
            disable: true
            test: [ "CMD-SHELL", "pgrep -f 'php artisan queue:work' || exit 1" ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 10s
        deploy:
            resources:
                limits:
                    cpus: '1.0'
                    memory: 2G
        env_file:
            - .env
        environment:
            APP_ENV: production
            DB_CONNECTION: mysql
            DB_HOST: db
            REDIS_HOST: redis
            REDIS_CLIENT: phpredis
            QUEUE_CONNECTION: redis
            CACHE_STORE: redis
            TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
            TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID}
            INSTAGRAM_BUSINESS_ACCOUNT_ID: ${INSTAGRAM_BUSINESS_ACCOUNT_ID}
            INSTAGRAM_ACCESS_TOKEN: ${INSTAGRAM_ACCESS_TOKEN}
            X_API_KEY: ${X_API_KEY}
            X_API_SECRET_KEY: ${X_API_SECRET_KEY}
            X_ACCESS_TOKEN: ${X_ACCESS_TOKEN}
            X_ACCESS_TOKEN_SECRET: ${X_ACCESS_TOKEN_SECRET}
            MAX_REQUESTS: 500
            MEMORY_LIMIT: 512M
            GD_PNG: 1
            GD_JPEG: 1
            GD_WEBP: 1
        volumes:
            #            - ./:/app
            - /app/vendor
            - /app/public/build
            - ./docker/php.ini:/usr/local/etc/php/conf.d/custom.ini
            - /tmp:/tmp
            - goat-storage:/app/storage/app/public
        depends_on:
            - db
            - redis
        networks:
            - goat-network

    scheduler:
        image: goat-app:latest
        restart: unless-stopped
        command: php artisan schedule:work
        healthcheck:
            disable: false
            test: [ "CMD-SHELL", "pgrep -f 'php artisan schedule:work' || exit 1" ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 10s
        deploy:
            resources:
                limits:
                    cpus: '0.25'
                    memory: 256M
        environment:
            APP_ENV: production
            DB_CONNECTION: mysql
            DB_HOST: db
            REDIS_HOST: redis
            REDIS_CLIENT: phpredis
            QUEUE_CONNECTION: redis
            CACHE_STORE: redis
        volumes:
            #            - ./:/app
            - /app/vendor
            - /app/public/build
            - ./docker/php.ini:/usr/local/etc/php/conf.d/custom.ini
            - goat-storage:/app/storage/app/public
        depends_on:
            - db
            - redis
        networks:
            - goat-network
    db:
        image: mysql:8.0
        ports:
            - "127.0.0.1:3306:3306"
        restart: always
        deploy:
            resources:
                limits:
                    cpus: '1.0'
                    memory: 1G
        environment:
            MYSQL_ROOT_PASSWORD: "${DB_PASSWORD}"
            MYSQL_DATABASE: "${DB_DATABASE}"
            MYSQL_USER: "${DB_USERNAME}"
            MYSQL_PASSWORD: "${DB_PASSWORD}"
        volumes:
            - goat-db-data:/var/lib/mysql
        networks:
            - goat-network
        healthcheck:
            test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
            timeout: 20s
            retries: 10

    redis:
        image: redis:alpine
        restart: always
        command: redis-server --appendonly yes
        deploy:
            resources:
                limits:
                    memory: 512M
        volumes:
            - goat-redis-data:/data
        networks:
            - goat-network

    #    pulse:
    #        image: goat-app:latest
    #        restart: unless-stopped
    #        command: php artisan pulse:check
    #        environment:
    #            APP_ENV: production
    #            DB_CONNECTION: mysql
    #            DB_HOST: db
    #            REDIS_HOST: redis
    #            REDIS_CLIENT: phpredis
    #        depends_on:
    #            - db
    #            - redis
    #        networks:
    #            - goat-network
    goat-search:
        build:
            context: ./goat-search
            dockerfile: Dockerfile
        restart: unless-stopped
        ports:
            - "127.0.0.1:9999:9999"
        networks:
            - goat-network
        volumes:
            - goat-search-data:/app
            - ./dashboard:/app

    portainer:
        image: portainer/portainer-ce:latest
        profiles: [ "maintenance" ]
        restart: no
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - portainer_data:/data
        ports:
            - "127.0.0.1:9000:9000"
        networks:
            - goat-network

    adminer:
        image: adminer
        profiles: [ "maintenance" ]
        restart: no
        environment:
            ADMINER_DESIGN: "pepa-lined"
        ports:
            - "127.0.0.1:8080:8080"
        networks:
            - goat-network

networks:
    goat-network:
        driver: bridge

volumes:
    caddy_data:
    goat-db-data:
    goat-redis-data:
    goat-search-data:
    goat-storage:
    portainer_data:
