<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GOAT Kernel // Deep Trace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
        mermaid.initialize({
            startOnLoad: false,
            layout: 'base',
            theme: 'neutral',
            flowchart: {
                curve: 'monotoneY',
                rankSpacing: 50,
                nodeSpacing: 50
            },
            themeVariables: {
                primaryColor: '#ffffff',
                lineColor: '#000000',
                fontFamily: 'Consolas, monospace',
                fontSize: '14px'
            }
        });
        window.mermaid = mermaid;
    </script>
    <style>
        body { background-color: #ffffff; color: #000; font-family: 'Consolas', 'Courier New', monospace; padding: 20px; }

        /* Raw Technical Look */
        .panel { border: 2px solid #000; padding: 0; margin-bottom: 20px; }
        .panel-header { background: #000; color: #fff; padding: 5px 10px; font-weight: bold; text-transform: uppercase; }
        .panel-body { padding: 10px; overflow: auto; }

        /* Compact Table */
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { border-bottom: 2px solid #000; text-align: left; padding: 4px; }
        td { border-bottom: 1px solid #ccc; padding: 4px; vertical-align: top; }

        /* Utility */
        .grid-layout { display: grid; grid-template-columns: 3fr 1fr; gap: 20px; height: 90vh; }
        .mono { font-family: 'Consolas', monospace; }

        #graph-container { min-height: 600px; }
    </style>
</head>
<body>

<div class="mb-4 border-b-2 border-black pb-2 flex justify-between items-end">
    <div>
        <h1 class="text-2xl font-bold uppercase">GOAT_SEARCH_DAEMON // KERNEL TRACE</h1>
        <div class="text-xs">PID: <span id="pid">ACTIVE</span> | MODE: HYBRID_RRF | THRESHOLD: 0.25</div>
    </div>
    <div class="text-right font-bold">
        LATENCY: <span id="q-latency">0.000 ms</span>
    </div>
</div>

<div class="grid-layout">

    <div class="panel flex flex-col">
        <div class="panel-header">EXECUTION PIPELINE VISUALIZATION</div>
        <div class="panel-body flex-1 bg-white relative">
            <div id="graph-container" class="w-full h-full flex items-center justify-center">
                <span class="animate-pulse">AWAITING_TELEMETRY_DATA...</span>
            </div>
        </div>
    </div>

    <div class="flex flex-col gap-4">

        <div class="panel">
            <div class="panel-header">INPUT_PARAMS</div>
            <div class="panel-body">
                <div class="text-xs text-gray-500">QUERY STRING</div>
                <div class="text-lg font-bold" id="q-term">--</div>
                <div class="mt-2 text-xs text-gray-500">TIMESTAMP</div>
                <div class="text-sm" id="last-update">--</div>
            </div>
        </div>

        <div class="panel flex-1 flex flex-col min-h-0">
            <div class="panel-header">OUTPUT_BUFFER (TOP_K=50)</div>
            <div class="panel-body p-0 flex-1 overflow-y-auto">
                <table>
                    <thead>
                    <tr>
                        <th style="width: 40px;">ID</th>
                        <th style="width: 50px;">SIM%</th>
                        <th>DATA_SNIPPET</th>
                    </tr>
                    </thead>
                    <tbody id="results-body">
                    </tbody>
                </table>
                <div id="no-results" class="hidden p-4 text-center text-xs text-gray-500">
                    [NULL_SET]
                    No vectors exceeded similarity threshold.
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    let lastTimestamp = "";

    async function fetchTelemetry() {
        try {
            const response = await fetch('telemetry_latest.json?nocache=' + new Date().getTime());
            if (!response.ok) throw new Error("File not ready");
            const data = await response.json();

            if (data.timestamp === lastTimestamp) return;
            lastTimestamp = data.timestamp;

            document.getElementById('last-update').innerText = data.timestamp;
            document.getElementById('q-latency').innerText = data.latency_ms.toFixed(3) + " ms";
            document.getElementById('q-term').innerText = `"${data.query}"`;

            renderTechnicalGraph(data);
            renderTable(data.results);

        } catch (e) {}
    }

    async function renderTechnicalGraph(data) {
        const container = document.getElementById('graph-container');
        const safeQuery = data.query.replace(/["<>&]/g, '');

        // --- THE COMPLEX ALGORITHM DEFINITION ---
        let graph = "graph TD\n";

        // 1. INPUT LAYER
        graph += `  Q["USER_INPUT: '${safeQuery}'"]:::input\n`;
        graph += `  TOK{{"TOKENIZER"}}:::process\n`;
        graph += `  Q --> TOK\n`;

        // 2. FORKING PATHS
        graph += `  subgraph PIPELINE [HYBRID_EXECUTION_CONTEXT]\n`;
        graph += `    direction TB\n`;

        // PATH A: BM25 (Simplified visual for clarity)
        graph += `    TOK -.->|Exact Tokens| LEX["LEXICAL_INDEX (BM25)"]:::bm25\n`;

        // PATH B: VECTOR (Detailed N-Gram logic)
        graph += `    subgraph VEC_PROCESS [VECTOR_EMBEDDING_SPACE]\n`;
        graph += `      direction TB\n`;

        // Draw N-Gram breakdown
        data.debug_tree.tokens.forEach((token, i) => {
            const safeTok = token.replace(/["<>&]/g, '');
            const tokId = `T${i}`;
            graph += `      TOK --> ${tokId}["'${safeTok}'"]:::token\n`;

            // N-Grams
            const relevantGrams = data.debug_tree.ngrams.filter(g => token.includes(g));
            relevantGrams.forEach((gram, j) => {
                const gramId = `G_${i}_${j}`;
                const safeGram = gram.replace(/["<>&]/g, '');
                graph += `      ${tokId} --> ${gramId}("${safeGram}"):::gram\n`;
                graph += `      ${gramId} -.-> HASH(("HASH_MAP")):::math\n`;
            });
        });
        graph += `    end\n`;

        graph += `    HASH ==> COSINE{{"COSINE_SIMILARITY"}}:::math\n`;
        graph += `  end\n`;

        // 3. FUSION LAYER (The "Engine" Logic)
        graph += `  subgraph FUSION [RANKING_ALGORITHM]\n`;
        graph += `    LEX -->|Weight: 0.7| MERGE((SCORE_MERGE)):::merge\n`;
        graph += `    COSINE -->|Weight: 0.3| MERGE\n`;
        graph += `    MERGE --> FILTER{{"THRESHOLD_FILTER (>0.25)"}}:::filter\n`;
        graph += `  end\n`;

        // 4. OUTPUT LAYER
        if (data.results.length > 0) {
            data.results.forEach(res => {
                const shortTitle = "#" + res.id;
                graph += `    FILTER -- ${res.score.toFixed(3)} --> R_${res.id}["DOC_${res.id}"]:::result\n`;
            });
        } else {
            graph += `    FILTER -.-> NULL[DISCARD_ALL]:::null\n`;
        }

        // STYLING DEFINITIONS (Black & White Technical)
        graph += `  classDef input fill:#000,stroke:#000,color:#fff,stroke-width:2px;\n`;
        graph += `  classDef process fill:#fff,stroke:#000,stroke-width:2px,stroke-dasharray: 5 5;\n`;
        graph += `  classDef bm25 fill:#eee,stroke:#000,stroke-width:1px;\n`;
        graph += `  classDef token fill:#fff,stroke:#000,stroke-width:1px;\n`;
        graph += `  classDef gram fill:#f9f9f9,stroke:#666,stroke-width:1px,font-size:10px;\n`;
        graph += `  classDef math fill:#000,stroke:#000,color:#fff,shape:circle;\n`;
        graph += `  classDef merge fill:#000,stroke:#000,color:#fff,shape:rect;\n`;
        graph += `  classDef filter fill:#fff,stroke:#000,stroke-width:3px;\n`;
        graph += `  classDef result fill:#ccc,stroke:#000,stroke-width:2px,font-weight:bold;\n`;
        graph += `  classDef null fill:#fff,stroke:#000,stroke-dasharray: 5 5;\n`;

        const graphDiv = document.getElementById('graph-container');
        graphDiv.innerHTML = `<pre class="mermaid">${graph}</pre>`;
        await window.mermaid.run({ nodes: [graphDiv.querySelector('.mermaid')] });
    }

    function renderTable(results) {
        const tbody = document.getElementById('results-body');
        const noRes = document.getElementById('no-results');
        tbody.innerHTML = '';

        if (!results || results.length === 0) {
            noRes.classList.remove('hidden');
            return;
        }
        noRes.classList.add('hidden');

        results.forEach(res => {
            const row = `
                    <tr>
                        <td><b>${res.id}</b></td>
                        <td>${res.score.toFixed(3)}</td>
                        <td class="text-xs text-gray-600 truncate max-w-[200px]" title="${res.snippet.replace(/"/g, '&quot;')}">
                            ${res.snippet.substring(0, 100)}...
                        </td>
                    </tr>
                `;
            tbody.innerHTML += row;
        });
    }

    setInterval(fetchTelemetry, 2000);
    fetchTelemetry();
</script>
</body>
</html>
